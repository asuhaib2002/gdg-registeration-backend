log:
  level: INFO

entryPoints:
  # HTTP entry point
  web:
    address: ':80'
    http:
      redirections:
        # Redirect HTTP traffic to HTTPS
        entryPoint:
          to: web-secure

  # HTTPS entry point
  web-secure:
    address: ':443'

certificatesResolvers:
  letsencrypt:
    acme:
      email: 'hellogdgkolachi@gmail.com'
      storage: /etc/traefik/acme/acme.json
      httpChallenge:
        entryPoint: web

http:
  # Routers to handle the different paths and services
  routers:
    # Main router for the Django application (serves the main app)
    web-secure-router:
      rule: 'Host(`devfest.gdgkolachi.com`) && PathPrefix(`/`)'
      entryPoints:
        - web-secure
      middlewares:
        - csrf
      service: django
      tls:
        certResolver: letsencrypt

    # Router for serving static files
    web-static-router:
      rule: 'Host(`devfest.gdgkolachi.com`) && PathPrefix(`/static/`)'
      entryPoints:
        - web-secure
      middlewares:
        - csrf
      service: django-static
      tls:
        certResolver: letsencrypt

    # Router for serving media files
    web-media-router:
      rule: 'Host(`devfest.gdgkolachi.com`) && PathPrefix(`/media/`)'
      entryPoints:
        - web-secure
      middlewares:
        - csrf
      service: django-media
      tls:
        certResolver: letsencrypt

  # Middleware for CSRF protection
  middlewares:
    csrf:
      headers:
        hostsProxyHeaders: ['X-CSRFToken']

  # Services definition
  services:
    # Django service to handle application requests
    django:
      loadBalancer:
        servers:
          - url: http://django:5000  # Django is running on port 5000 in Docker

    # Django static service to serve static files (handled by Django)
    django-static:
      loadBalancer:
        servers:
          - url: http://django:5000  # Static files should be served from Django itself

    # Nginx service to handle media files
    django-media:
      loadBalancer:
        servers:
          - url: http://nginx:80  # Nginx should serve media files

providers:
  file:
    filename: /etc/traefik/traefik.yml
    watch: true
